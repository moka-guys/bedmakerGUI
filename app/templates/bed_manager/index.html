{% extends 'base.html' %}

{% block title %}BED Manager{% endblock %}

{% block content %}
    <!-- Page Title Card -->
    <div class="card shadow-sm mb-4" style="background-color: #f8f9fa;">
        <div class="card-body text-center" style="background-color: #fafafa;">
            <h4 class="my-1 page-title">Manage BED Files</h4>
        </div>
    </div>
    
    <!-- Draft BED files card -->
    <div class="card shadow-sm mb-4" style="background-color: #f8f9fa;">
        <div class="card-header">
            Draft BED Files
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>File Name</th>
                            <th>Submitter</th>
                            <th>5' UTR</th>
                            <th>3' UTR</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for bed_file in bed_files if bed_file.status != 'published' %}
                            <tr>
                                <td>{{ bed_file.id }}</td>
                                <td>{{ bed_file.filename }}</td>
                                <td>{{ bed_file.submitter.username }}</td>
                                <td class="text-center">
                                    {% if bed_file.include_5utr %}
                                        <i class="bi bi-check-circle-fill text-success" title="5' UTR included"></i>
                                    {% else %}
                                        <i class="bi bi-x-circle-fill text-muted" title="5' UTR not included"></i>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if bed_file.include_3utr %}
                                        <i class="bi bi-check-circle-fill text-success" title="3' UTR included"></i>
                                    {% else %}
                                        <i class="bi bi-x-circle-fill text-muted" title="3' UTR not included"></i>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge rounded-pill bg-{{ bed_file.status|lower }}">
                                        {{ bed_file.status }}
                                    </span>
                                </td>
                                <td>
                                    {% if current_user.is_authorizer %}
                                        <button class="btn btn-primary btn-sm review-bed-file" data-file-id="{{ bed_file.id }}">Review</button>
                                        <button class="btn btn-danger btn-sm remove-bed-file" data-file-id="{{ bed_file.id }}">Delete entry</button>
                                    {% endif %}
                                    <button class="btn btn-info btn-sm view-details" data-file-id="{{ bed_file.id }}">View original query</button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Published BED files card -->
    <div class="card shadow-sm mb-4">
        <div class="card-header" style="background-color: #b9fbd8;">
            Live BED Files
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>File Name</th>
                            <th>Submitter</th>
                            <th>Authoriser</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for bed_file in bed_files if bed_file.status == 'published' %}
                            <tr>
                                <td>{{ bed_file.id }}</td>
                                <td>{{ bed_file.filename }}</td>
                                <td>{{ bed_file.submitter.username }}</td>
                                <td>{{ bed_file.authorizer.username }}</td>
                                <td>
                                    <button class="btn btn-success btn-sm open-in-results" data-file-id="{{ bed_file.id }}">Open in Results editor</button>
                                    {% if current_user.is_authorizer %}                                        
                                        <button class="btn btn-danger btn-sm remove-bed-file" data-file-id="{{ bed_file.id }}">Delete entry</button>
                                    {% endif %}
                                    <button class="btn btn-info btn-sm view-details" data-file-id="{{ bed_file.id }}">View original query</button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal for BED file details -->
    <div class="modal fade" id="bedFileModal" tabindex="-1" aria-labelledby="bedFileModalLabel" aria-hidden="true">
        <div class="modal-dialog" style="max-width: 70vw;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bedFileModalLabel">Original Query Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="bedFileModalBody" style="max-height: 70vh; overflow-y: auto;">
                    <!-- Content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" data-file-id="">Authorise and publish BED</button>
                    <button type="button" class="btn btn-success" onclick="reloadBedResults(this.getAttribute('data-file-id'))">Open in Results editor</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Original query details modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailsModalLabel">BED File Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <p><strong>Created:</strong> <span id="createdDate"></span></p>
                        <p><strong>Last Updated:</strong> <span id="updatedDate"></span></p>
                    </div>
                    
                    <div class="mb-3">
                        <p><strong>Initial query workflow:</strong></p>
                        <div class="query-workflow" id="queryWorkflow">
                            <!-- Content will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var bedFileModal = new bootstrap.Modal(document.getElementById('bedFileModal'));
            
            // Review button click handler
            document.querySelectorAll('.review-bed-file').forEach(function(button) {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    var fileId = this.getAttribute('data-file-id');
                    fetch('/bed_manager/bed_file_details/' + fileId)
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById('bedFileModalBody').innerHTML = html;
                        document.querySelector('#bedFileModal .btn-primary').setAttribute('data-file-id', fileId);
                        document.querySelector('#bedFileModal .btn-success').setAttribute('data-file-id', fileId);
                        
                        // Add the fileAction event listener only after the modal content is loaded
                        const fileActionSelect = document.getElementById('fileAction');
                        if (fileActionSelect) {
                            fileActionSelect.addEventListener('change', showComparison);
                        }
                        
                        bedFileModal.show();
                    });
                });
            });

            document.querySelectorAll('.remove-bed-file').forEach(function(button) {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (confirm('Are you sure you want to remove this BED file?')) {
                        var fileId = this.getAttribute('data-file-id');
                        fetch('/bed_manager/remove/' + fileId, { method: 'POST' })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    this.closest('tr').remove();
                                } else {
                                    alert('Failed to remove BED file: ' + data.error);
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('An error occurred while removing the BED file.');
                            });
                    }
                });
            });

            // Add event listener for "Open in Results editor" buttons in the Live BED table
            document.querySelectorAll('.open-in-results').forEach(function(button) {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    var fileId = this.getAttribute('data-file-id');
                    reloadBedResults(fileId);
                });
            });

            // Update the "Authorise and publish BED" button click handler
            document.querySelector('#bedFileModal .btn-primary').addEventListener('click', function() {
                // Add warning acknowledgment check
                if (document.getElementById('warningAcknowledged')) {
                    if (!document.getElementById('warningAcknowledged').checked) {
                        alert('Please acknowledge the warnings before authorising this file.');
                        return;
                    }
                }

                var fileId = this.getAttribute('data-file-id');
                var fileAction = document.getElementById('fileAction').value;
                
                fetch(`/bed_manager/authorise/${fileId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        fileAction: fileAction,
                        warningsAcknowledged: true
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Create and show the alert
                        var alert = document.createElement('div');
                        alert.className = 'alert alert-success alert-dismissible fade show';
                        alert.role = 'alert';
                        alert.innerHTML = `
                            <strong>Success!</strong> ${data.message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        `;
                        document.querySelector('.container').insertBefore(alert, document.querySelector('.container').firstChild);

                        // Reload the page after a short delay
                        setTimeout(() => {
                            location.reload();
                        }, 3000);
                    } else {
                        alert('Failed to authorise and publish BED file: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while authorising the BED file.');
                });
            });

            function reloadBedResults(fileId) {
                fetch(`/bed_manager/reload_bed_results/${fileId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Store any warnings in localStorage before redirecting
                            const warningSection = document.getElementById('warningSection');
                            if (warningSection && warningSection.style.display !== 'none') {
                                const warningContent = document.getElementById('warningContent').innerHTML;
                                localStorage.setItem('bedWarnings', warningContent);
                            } else {
                                localStorage.removeItem('bedWarnings');
                            }
                            window.location.href = data.redirect_url;
                        } else {
                            alert('Failed to reload BED results: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while reloading the BED results.');
                    });
            }

            function showComparison() {
                var fileAction = document.getElementById('fileAction');
                var comparisonView = document.getElementById('comparisonView');
                var publishedFileContent = document.getElementById('existingFileContent');
                var newFileContent = document.getElementById('newFileContent');
                var existingFileHeader = document.getElementById('existingFileHeader');
                var newFileHeader = document.getElementById('newFileHeader');

                var fileId = document.querySelector('#bedFileModal .btn-primary').getAttribute('data-file-id');
                var selectedFileId = fileAction.value;
                
                fetch(`/bed_manager/compare_bed_files/${fileId}?selected_file_id=${selectedFileId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        newFileContent.innerHTML = formatBedContent(data.new_file);
                        publishedFileContent.innerHTML = data.message ? 
                            `<p>${data.message}</p>` : 
                            formatBedContent(data.published_file);
                        comparisonView.style.display = 'block';
                        
                        // Update headers with file names
                        newFileHeader.textContent = data.new_file_name || 'New Version';
                        existingFileHeader.textContent = data.published_file_name || 'Published Version';
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while comparing BED files: ' + error.message);
                        comparisonView.style.display = 'none';
                    });
            }

            function formatBedContent(content) {
                if (!Array.isArray(content)) {
                    console.error('Expected an array, but got:', content);
                    return 'Error: Invalid data format';
                }
                return content.map(entry => 
                    `${entry.chromosome}\t${entry.start}\t${entry.end}\t${entry.gene}`
                ).join('<br>');
            }
        });

            // Use event delegation for "View Details" buttons
            document.body.addEventListener('click', function(e) {
                if (e.target && e.target.classList.contains('view-details')) {
                    e.preventDefault();
                    var fileId = e.target.getAttribute('data-file-id');

                    fetch('/bed_manager/file_details/' + fileId)
                        .then(response => response.json())
                        .then(data => {
                            console.log('Received data:', data);
                            console.log('Initial query:', data.initial_query);
                            
                            document.getElementById('createdDate').textContent = new Date(data.created_at).toLocaleString();
                            document.getElementById('updatedDate').textContent = new Date(data.updated_at).toLocaleString();
                            
                            // Format the workflow visualization
                            const initialQuery = typeof data.initial_query === 'string' ? 
                                JSON.parse(data.initial_query) : data.initial_query;
                            
                            console.log('Parsed query:', initialQuery);
                            
                            document.getElementById('queryWorkflow').innerHTML = 
                                formatQueryWorkflow(initialQuery);
                            
                            var detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));
                            detailsModal.show();
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An error occurred while fetching file details.');
                        });
                }
            });

        function reloadBedResults(fileId) {
            fetch(`/bed_manager/reload_bed_results/${fileId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = data.redirect_url;
                    } else {
                        alert('Failed to reload BED results: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while reloading the BED results.');
                });
        }

        function showComparison() {
            var fileAction = document.getElementById('fileAction');
            var comparisonView = document.getElementById('comparisonView');
            var publishedFileContent = document.getElementById('existingFileContent');
            var newFileContent = document.getElementById('newFileContent');
            var existingFileHeader = document.getElementById('existingFileHeader');
            var newFileHeader = document.getElementById('newFileHeader');

            var fileId = document.querySelector('#bedFileModal .btn-primary').getAttribute('data-file-id');
            var selectedFileId = fileAction.value;
            
            fetch(`/bed_manager/compare_bed_files/${fileId}?selected_file_id=${selectedFileId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    newFileContent.innerHTML = formatBedContent(data.new_file);
                    publishedFileContent.innerHTML = data.message ? 
                        `<p>${data.message}</p>` : 
                        formatBedContent(data.published_file);
                    comparisonView.style.display = 'block';
                    
                    // Update headers with file names
                    newFileHeader.textContent = data.new_file_name || 'New Version';
                    existingFileHeader.textContent = data.published_file_name || 'Published Version';
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while comparing BED files: ' + error.message);
                    comparisonView.style.display = 'none';
                });
        }

        function formatBedContent(content) {
            if (!Array.isArray(content)) {
                console.error('Expected an array, but got:', content);
                return 'Error: Invalid data format';
            }
            return content.map(entry => 
                `${entry.chromosome}\t${entry.start}\t${entry.end}\t${entry.gene}`
            ).join('<br>');
        }

        function formatQueryWorkflow(queryData) {
            const workflowSteps = [];
            
            // Assembly Selection Step
            if (queryData.assembly) {
                workflowSteps.push({
                    icon: 'bi-diagram-3-fill',
                    title: 'Assembly Selection',
                    content: `<div class="parameter-tag">
                        <span class="param-label">Assembly:</span>
                        <span class="param-value">${queryData.assembly}</span>
                    </div>`
                });
            }

            // Input Parameters Step
            if (queryData.coordinates || queryData.identifiers) {
                workflowSteps.push({
                    icon: 'bi-input-cursor-text',
                    title: 'Input Data',
                    content: `
                        <div class="d-flex gap-2">
                            ${queryData.coordinates ? `
                                <button class="btn btn-outline-primary btn-sm" onclick='showDataModal("Coordinates", \`${queryData.coordinates}\`)'>
                                    <i class="bi bi-geo-alt"></i> Coordinates
                                </button>
                            ` : ''}
                            ${queryData.identifiers ? `
                                <button class="btn btn-outline-primary btn-sm" onclick='showDataModal("Identifiers", \`${queryData.identifiers}\`)'>
                                    <i class="bi bi-list"></i> ${queryData.identifiers.split('\n').length} transcripts
                                </button>
                            ` : ''}
                        </div>
                    `
                });
            }

            // Standard Padding Settings
            if (queryData.settings && queryData.settings.padding && queryData.settings.padding.standard !== undefined) {
                workflowSteps.push({
                    icon: 'bi-arrows-expand',
                    title: 'Standard Padding',
                    content: `
                        <div class="parameter-tag">
                            <span class="param-label">Padding:</span>
                            <span class="param-value">${queryData.settings.padding.standard}bp</span>
                        </div>
                    `
                });
            }

            // SNP Padding Settings (as separate section)
            if (queryData.settings && queryData.settings.padding && queryData.settings.padding.snp !== undefined) {
                workflowSteps.push({
                    icon: 'bi-bullseye',
                    title: 'SNP Settings',
                    content: `
                        <div class="parameter-tag">
                            <span class="param-label">SNP Padding:</span>
                            <span class="param-value">${queryData.settings.padding.snp}bp</span>
                        </div>
                    `
                });
            }

            // UTR Settings
            const utrSettings = [];
            if (queryData.settings && queryData.settings.hasOwnProperty('include_5utr')) {
                utrSettings.push(`
                    <div class="parameter-tag">
                        <span class="param-label">5' UTR:</span>
                        <span class="param-value">${queryData.settings.include_5utr ? 'Included' : 'Excluded'}</span>
                    </div>
                `);
            }
            if (queryData.settings && queryData.settings.hasOwnProperty('include_3utr')) {
                utrSettings.push(`
                    <div class="parameter-tag">
                        <span class="param-label">3' UTR:</span>
                        <span class="param-value">${queryData.settings.include_3utr ? 'Included' : 'Excluded'}</span>
                    </div>
                `);
            }
            if (utrSettings.length > 0) {
                workflowSteps.push({
                    icon: 'bi-toggles',
                    title: 'UTR Settings',
                    content: utrSettings.join('')
                });
            }

            // Add a button to view raw query details
            const rawQueryButton = `
                <button class="btn btn-outline-secondary btn-sm mt-3" onclick='showRawQuery(${JSON.stringify(JSON.stringify(queryData))})'>
                    <i class="bi bi-code-slash"></i> View Raw Query
                </button>
            `;

            return `
                ${workflowSteps.map(step => `
                    <div class="workflow-step">
                        <div class="step-header">
                            <i class="bi ${step.icon} step-icon"></i>
                            <span class="step-title">${step.title}</span>
                        </div>
                        <div class="step-content">
                            ${step.content}
                        </div>
                    </div>
                `).join('')}
                ${rawQueryButton}
            `;
        }

        function showRawQuery(queryDataStr) {
            // Parse the stringified data back to an object
            const queryData = JSON.parse(queryDataStr);
            
            // Create a modal for the raw query
            const modalHtml = `
                <div class="modal fade" id="rawQueryModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Raw Query Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <pre class="bg-light p-3 rounded"><code>${JSON.stringify(queryData, null, 2)}</code></pre>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if it exists
            const existingModal = document.getElementById('rawQueryModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add the modal to the document
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('rawQueryModal'));
            modal.show();
        }

        function formatParameterTags(parameters) {
            return Object.entries(parameters)
                .map(([key, value]) => `
                    <div class="parameter-tag">
                        <span class="param-label">${formatKeyName(key)}:</span>
                        <span class="param-value">${formatValue(value)}</span>
                    </div>
                `).join('');
        }

        function formatKeyName(key) {
            return key.split('_').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        function formatValue(value) {
            if (typeof value === 'boolean') {
                return value ? 'Yes' : 'No';
            }
            if (typeof value === 'number') {
                return value.toString();
            }
            return value;
        }

        // Add this function to handle showing the data modal
        function showDataModal(title, content) {
            // Remove existing modal if present
            const existingModal = document.getElementById('dataModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Create modal HTML
            const modalHtml = `
                <div class="modal fade" id="dataModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${title}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <pre class="bg-light p-3 rounded"><code>${content}</code></pre>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to document
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('dataModal'));
            modal.show();
        }
    </script>
{% endblock %}

