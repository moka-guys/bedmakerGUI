{% extends 'base.html' %}

{% block title %}BED Manager{% endblock %}

{% block content %}
    <!-- Page Title Card -->
    <div class="card shadow-sm mb-4" style="background-color: #f8f9fa;">
        <div class="card-body text-center" style="background-color: #fafafa;">
            <h4 class="my-1 page-title">Manage BED Files</h4>
        </div>
    </div>
    
    <!-- Draft BED files card -->
    <div class="card shadow-sm mb-4">
        <div class="card-header" style="background-color: #f8f9fa;">
            <i class="bi bi-file-earmark-text" style="padding-right: 5px;"></i>Pending BED Files
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-striped mb-0">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>File Name</th>
                            <th>Submitter</th>
                            <th>5' UTR</th>
                            <th>3' UTR</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for bed_file in bed_files if bed_file.status != 'published' %}
                            <tr>
                                <td>{{ bed_file.id }}</td>
                                <td>{{ bed_file.filename }}</td>
                                <td>{{ bed_file.submitter.username }}</td>
                                <td class="text-center">
                                    {% if bed_file.include_5utr %}
                                        <i class="bi bi-check-circle-fill text-success" title="5' UTR included"></i>
                                    {% else %}
                                        <i class="bi bi-x-circle-fill text-muted" title="5' UTR not included"></i>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if bed_file.include_3utr %}
                                        <i class="bi bi-check-circle-fill text-success" title="3' UTR included"></i>
                                    {% else %}
                                        <i class="bi bi-x-circle-fill text-muted" title="3' UTR not included"></i>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge rounded-pill bg-{{ bed_file.status|lower }}">
                                        {{ bed_file.status }}
                                    </span>
                                </td>
                                <td>
                                    {% if current_user.is_authorizer %}
                                        <button class="btn btn-primary btn-sm review-bed-file" data-file-id="{{ bed_file.id }}">Review</button>
                                        <button class="btn btn-danger btn-sm remove-bed-file" data-file-id="{{ bed_file.id }}">Delete entry</button>
                                    {% endif %}
                                    <button class="btn btn-info btn-sm view-details" data-file-id="{{ bed_file.id }}">View original query</button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Published BED files card -->
    <div class="card shadow-sm mb-4">
        <div class="card-header" style="background-color: #b9fbd8;">
            <i class="bi bi-check-circle" style="padding-right: 5px;"></i>Live BED Files
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-striped mb-0">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>File Name</th>
                            <th>Submitter</th>
                            <th>Authoriser</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for bed_file in bed_files if bed_file.status == 'published' %}
                            <tr>
                                <td>{{ bed_file.id }}</td>
                                <td>{{ bed_file.filename }}</td>
                                <td>{{ bed_file.submitter.username }}</td>
                                <td>{{ bed_file.authorizer.username }}</td>
                                <td>
                                    <button class="btn btn-success btn-sm open-in-results" data-file-id="{{ bed_file.id }}">Open in Results editor</button>
                                    {% if current_user.is_authorizer %}                                        
                                        <button class="btn btn-danger btn-sm remove-bed-file" data-file-id="{{ bed_file.id }}">Delete entry</button>
                                    {% endif %}
                                    <button class="btn btn-info btn-sm view-details" data-file-id="{{ bed_file.id }}">View original query</button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal for BED file details -->
    <div class="modal fade" id="bedFileModal">
        <div class="modal-dialog" style="max-width: 70vw;">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(45deg, #f8f9fa, #ffffff);">
                    <h5 class="modal-title" style="color: #004a99; font-weight: 600; letter-spacing: 0.5px;">
                        <i class="bi bi-file-text" style="padding-right: 5px;"></i>Original Query Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="background-color: #fafafa;">
                    <!-- Content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" data-file-id="">Authorise and publish BED</button>
                    <button type="button" class="btn btn-success" onclick="reloadBedResults(this.getAttribute('data-file-id'))">Open in Results editor</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Original query details modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailsModalLabel">BED File Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="query-workflow" id="queryWorkflow">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                </div>
                <div class="modal-footer justify-content-start">
                    <button class="btn btn-primary" onclick="reQueryData(this.getAttribute('data-query'))">
                        <i class="bi bi-arrow-repeat"></i> Re-run Query
                    </button>
                    <button class="btn btn-outline-secondary" onclick="showRawQuery(this.getAttribute('data-query'))">
                        <i class="bi bi-code-slash"></i> View Raw Query
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var bedFileModal = new bootstrap.Modal(document.getElementById('bedFileModal'));
            
            // Review button click handler
            document.querySelectorAll('.review-bed-file').forEach(function(button) {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    var fileId = this.getAttribute('data-file-id');
                    fetch('/bed_manager/bed_file_details/' + fileId)
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById('bedFileModalBody').innerHTML = html;
                        document.querySelector('#bedFileModal .btn-primary').setAttribute('data-file-id', fileId);
                        document.querySelector('#bedFileModal .btn-success').setAttribute('data-file-id', fileId);
                        
                        // Add the fileAction event listener only after the modal content is loaded
                        const fileActionSelect = document.getElementById('fileAction');
                        if (fileActionSelect) {
                            fileActionSelect.addEventListener('change', showComparison);
                        }
                        
                        bedFileModal.show();
                    });
                });
            });

            document.querySelectorAll('.remove-bed-file').forEach(function(button) {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (confirm('Are you sure you want to remove this BED file?')) {
                        var fileId = this.getAttribute('data-file-id');
                        fetch('/bed_manager/remove/' + fileId, { method: 'POST' })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    this.closest('tr').remove();
                                } else {
                                    alert('Failed to remove BED file: ' + data.error);
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('An error occurred while removing the BED file.');
                            });
                    }
                });
            });

            // Add event listener for "Open in Results editor" buttons in the Live BED table
            document.querySelectorAll('.open-in-results').forEach(function(button) {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    var fileId = this.getAttribute('data-file-id');
                    reloadBedResults(fileId);
                });
            });

            // Update the "Authorise and publish BED" button click handler
            document.querySelector('#bedFileModal .btn-primary').addEventListener('click', function() {
                // Add warning acknowledgment check
                if (document.getElementById('warningAcknowledged')) {
                    if (!document.getElementById('warningAcknowledged').checked) {
                        alert('Please acknowledge the warnings before authorising this file.');
                        return;
                    }
                }

                var fileId = this.getAttribute('data-file-id');
                var fileAction = document.getElementById('fileAction').value;
                
                fetch(`/bed_manager/authorise/${fileId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        fileAction: fileAction,
                        warningsAcknowledged: true
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Create and show the alert
                        var alert = document.createElement('div');
                        alert.className = 'alert alert-success alert-dismissible fade show';
                        alert.role = 'alert';
                        alert.innerHTML = `
                            <strong>Success!</strong> ${data.message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        `;
                        document.querySelector('.container').insertBefore(alert, document.querySelector('.container').firstChild);

                        // Reload the page after a short delay
                        setTimeout(() => {
                            location.reload();
                        }, 3000);
                    } else {
                        alert('Failed to authorise and publish BED file: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while authorising the BED file.');
                });
            });

            function reloadBedResults(fileId) {
                fetch(`/bed_manager/reload_bed_results/${fileId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Store any warnings in localStorage before redirecting
                            const warningSection = document.getElementById('warningSection');
                            if (warningSection && warningSection.style.display !== 'none') {
                                const warningContent = document.getElementById('warningContent').innerHTML;
                                localStorage.setItem('bedWarnings', warningContent);
                            } else {
                                localStorage.removeItem('bedWarnings');
                            }
                            window.location.href = data.redirect_url;
                        } else {
                            alert('Failed to reload BED results: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while reloading the BED results.');
                    });
            }

            function showComparison() {
                var fileAction = document.getElementById('fileAction');
                var comparisonView = document.getElementById('comparisonView');
                var publishedFileContent = document.getElementById('existingFileContent');
                var newFileContent = document.getElementById('newFileContent');
                var existingFileHeader = document.getElementById('existingFileHeader');
                var newFileHeader = document.getElementById('newFileHeader');

                var fileId = document.querySelector('#bedFileModal .btn-primary').getAttribute('data-file-id');
                var selectedFileId = fileAction.value;
                
                fetch(`/bed_manager/compare_bed_files/${fileId}?selected_file_id=${selectedFileId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        newFileContent.innerHTML = formatBedContent(data.new_file);
                        publishedFileContent.innerHTML = data.message ? 
                            `<p>${data.message}</p>` : 
                            formatBedContent(data.published_file);
                        comparisonView.style.display = 'block';
                        
                        // Update headers with file names
                        newFileHeader.textContent = data.new_file_name || 'New Version';
                        existingFileHeader.textContent = data.published_file_name || 'Published Version';
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while comparing BED files: ' + error.message);
                        comparisonView.style.display = 'none';
                    });
            }

            function formatBedContent(content) {
                if (!Array.isArray(content)) {
                    console.error('Expected an array, but got:', content);
                    return 'Error: Invalid data format';
                }
                return content.map(entry => 
                    `${entry.chromosome}\t${entry.start}\t${entry.end}\t${entry.gene}`
                ).join('<br>');
            }
        });

            // Use event delegation for "View Details" buttons
            document.body.addEventListener('click', function(e) {
                if (e.target && e.target.classList.contains('view-details')) {
                    e.preventDefault();
                    var fileId = e.target.getAttribute('data-file-id');

                    fetch('/bed_manager/file_details/' + fileId)
                        .then(response => response.json())
                        .then(data => {
                            console.log('Received data:', data);
                            
                            // Format the workflow visualization
                            const initialQuery = typeof data.initial_query === 'string' ? 
                                JSON.parse(data.initial_query) : data.initial_query;
                            
                            // Get submitter from the table row
                            const row = e.target.closest('tr');
                            const submitterCell = row.querySelector('td:nth-child(3)');
                            const submitter = submitterCell ? submitterCell.textContent.trim() : 'Not available';
                            
                            // Format dates
                            const formatDate = (dateStr) => {
                                if (!dateStr) return 'Not available';
                                const date = new Date(dateStr);
                                return date.toLocaleString('en-GB', {
                                    day: '2-digit',
                                    month: '2-digit',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                            };
                            
                            // Combine file metadata with query data
                            const combinedData = {
                                ...initialQuery,
                                created_date: formatDate(data.created_at),
                                updated_date: formatDate(data.updated_at),
                                submitter: submitter
                            };
                            
                            document.getElementById('queryWorkflow').innerHTML = 
                                formatQueryWorkflow(combinedData);
                            
                            var detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));
                            detailsModal.show();
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An error occurred while fetching file details.');
                        });
                }
            });

        function reloadBedResults(fileId) {
            fetch(`/bed_manager/reload_bed_results/${fileId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = data.redirect_url;
                    } else {
                        alert('Failed to reload BED results: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while reloading the BED results.');
                });
        }

        function showComparison() {
            var fileAction = document.getElementById('fileAction');
            var comparisonView = document.getElementById('comparisonView');
            var publishedFileContent = document.getElementById('existingFileContent');
            var newFileContent = document.getElementById('newFileContent');
            var existingFileHeader = document.getElementById('existingFileHeader');
            var newFileHeader = document.getElementById('newFileHeader');

            var fileId = document.querySelector('#bedFileModal .btn-primary').getAttribute('data-file-id');
            var selectedFileId = fileAction.value;
            
            fetch(`/bed_manager/compare_bed_files/${fileId}?selected_file_id=${selectedFileId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    newFileContent.innerHTML = formatBedContent(data.new_file);
                    publishedFileContent.innerHTML = data.message ? 
                        `<p>${data.message}</p>` : 
                        formatBedContent(data.published_file);
                    comparisonView.style.display = 'block';
                    
                    // Update headers with file names
                    newFileHeader.textContent = data.new_file_name || 'New Version';
                    existingFileHeader.textContent = data.published_file_name || 'Published Version';
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while comparing BED files: ' + error.message);
                    comparisonView.style.display = 'none';
                });
        }

        function formatBedContent(content) {
            if (!Array.isArray(content)) {
                console.error('Expected an array, but got:', content);
                return 'Error: Invalid data format';
            }
            return content.map(entry => 
                `${entry.chromosome}\t${entry.start}\t${entry.end}\t${entry.gene}`
            ).join('<br>');
        }

        function formatQueryWorkflow(queryData) {
            // Store the query data on the buttons
            document.querySelector('#detailsModal .modal-footer .btn-primary')
                .setAttribute('data-query', JSON.stringify(queryData));
            document.querySelector('#detailsModal .modal-footer .btn-outline-secondary')
                .setAttribute('data-query', JSON.stringify(JSON.stringify(queryData)));
            
            // Define workflow steps
            const workflowSteps = [
                {
                    icon: 'bi-info-circle',
                    title: 'File Information',
                    content: `
                        <div class="parameter-tag">
                            <span class="param-label">Created:</span>
                            <span class="param-value">${queryData.created_date || 'Not available'}</span>
                        </div>
                        <div class="parameter-tag">
                            <span class="param-label">Last Updated:</span>
                            <span class="param-value">${queryData.updated_date || 'Not available'}</span>
                        </div>
                        <div class="parameter-tag">
                            <span class="param-label">Created By:</span>
                            <span class="param-value">${queryData.submitter || 'Not available'}</span>
                        </div>
                    `
                },
                {
                    icon: 'bi-diagram-3-fill',
                    title: 'Assembly Selection',
                    content: `
                        <div class="parameter-tag">
                            <span class="param-label">Assembly:</span>
                            <span class="param-value">${queryData.assembly || 'Not available'}</span>
                        </div>
                    `
                },
                {
                    icon: 'bi-input-cursor-text',
                    title: 'Input Data',
                    content: `
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-geo-alt"></i> Coordinates
                            </button>
                            <button class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-list-ol"></i> ${queryData.transcripts || 4} transcripts
                            </button>
                        </div>
                    `
                },
                {
                    icon: 'bi-arrows-expand',
                    title: 'Standard Padding',
                    content: `
                        <div class="parameter-tag">
                            <span class="param-label">Padding:</span>
                            <span class="param-value">${queryData.padding || '30bp'}</span>
                        </div>
                    `
                },
                {
                    icon: 'bi-record-circle',
                    title: 'SNP Settings',
                    content: `
                        <div class="parameter-tag">
                            <span class="param-label">SNP Padding:</span>
                            <span class="param-value">${queryData.snp_padding || '5bp'}</span>
                        </div>
                    `
                },
                {
                    icon: 'bi-gear',
                    title: 'UTR Settings',
                    content: `
                        <div class="d-flex gap-2">
                            <div class="parameter-tag">
                                <span class="param-label">5' UTR:</span>
                                <span class="param-value">${queryData.include_5utr ? 'Yes' : 'No'}</span>
                            </div>
                            <div class="parameter-tag">
                                <span class="param-label">3' UTR:</span>
                                <span class="param-value">${queryData.include_3utr ? 'Yes' : 'No'}</span>
                            </div>
                        </div>
                    `
                }
            ];

            // Create the workflow steps HTML with no arrows
            const stepsHtml = workflowSteps.map(step => `
                <div class="workflow-step">
                    <div class="step-header">
                        <i class="bi ${step.icon} step-icon"></i>
                        <span class="step-title">${step.title}</span>
                    </div>
                    <div class="step-content">
                        ${step.content}
                    </div>
                </div>
            `).join('');

            return stepsHtml;
        }

        function showRawQuery(queryDataStr) {
            // Parse the stringified data back to an object
            const queryData = JSON.parse(queryDataStr);
            
            // Create a modal for the raw query
            const modalHtml = `
                <div class="modal fade" id="rawQueryModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Raw Query Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <pre class="bg-light p-3 rounded"><code>${JSON.stringify(queryData, null, 2)}</code></pre>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if it exists
            const existingModal = document.getElementById('rawQueryModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add the modal to the document
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('rawQueryModal'));
            modal.show();
        }

        function formatParameterTags(parameters) {
            return Object.entries(parameters)
                .map(([key, value]) => `
                    <div class="parameter-tag">
                        <span class="param-label">${formatKeyName(key)}:</span>
                        <span class="param-value">${formatValue(value)}</span>
                    </div>
                `).join('');
        }

        function formatKeyName(key) {
            return key.split('_').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        function formatValue(value) {
            if (typeof value === 'boolean') {
                return value ? 'Yes' : 'No';
            }
            if (typeof value === 'number') {
                return value.toString();
            }
            return value;
        }

        // Add this function to handle showing the data modal
        function showDataModal(title, content) {
            // Remove existing modal if present
            const existingModal = document.getElementById('dataModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Create modal HTML
            const modalHtml = `
                <div class="modal fade" id="dataModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${title}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <pre class="bg-light p-3 rounded"><code>${content}</code></pre>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to document
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('dataModal'));
            modal.show();
        }

        // Updated function to handle re-querying with all original data
        function reQueryData(queryDataStr) {
            try {
                // Parse the stringified query data
                const queryData = JSON.parse(queryDataStr);
                
                // Create a form to submit the data
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/bed_generator';

                // Add CSRF token if needed
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
                if (csrfToken) {
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = 'csrf_token';
                    csrfInput.value = csrfToken;
                    form.appendChild(csrfInput);
                }

                // Add all query parameters as hidden inputs
                Object.entries(queryData).forEach(([key, value]) => {
                    // Skip null, undefined, or empty values
                    if (value == null || value === '') return;
                    
                    // Create input for each parameter
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = typeof value === 'object' ? JSON.stringify(value) : value;
                    form.appendChild(input);
                });

                // Add the form to the document and submit
                document.body.appendChild(form);
                form.submit();
            } catch (error) {
                console.error('Error processing query data:', error);
                alert('Failed to re-run query. Please try again.');
            }
        }
    </script>
{% endblock %}