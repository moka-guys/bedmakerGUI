{% extends 'base.html' %}

{% block title %}SampleSheet Validator{% endblock %}

{% block content %}
    {% if request.args.get('correction_success') %}
        <div class="alert alert-warning">
            RunParameters.xml has been successfully updated. Please reupload the samplesheet to validate again.
        </div>
    {% elif request.args.get('correction_failed') %}
        <div class="alert alert-danger">
            Failed to update RunParameters.xml. Please check the file permissions and try again.
        </div>
    {% endif %}

    {% if results %}
        {% if results.errors %}
            <div class="alert alert-danger">
                <h4>Errors:</h4>
                <ul>
                    {% for error in results.errors %}
                        <li>{{ error | safe }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}

        {% if results.experiment_name_mismatch %}
            <div class="alert alert-warning">
                <h4>Experiment Name Mismatch</h4>
                <p>There is a mismatch between the Experiment Name in the SampleSheet and the RunParameters.xml file.</p>
                <p><strong>SampleSheet Experiment Name:</strong> {{ results.experiment_name }}</p>
                <p><strong>RunParameters.xml Experiment Name:</strong> {{ results.run_parameters_experiment_name }}</p>
                <p><strong>How the RunParameters.xml Experiment Name is generated:</strong><br>
                The Experiment Name in RunParameters.xml is typically generated automatically by the sequencing instrument at the start of a run. It often uses the run name or a combination of date, instrument ID, and run number. This name is separate from the one specified in the SampleSheet, which is why mismatches can occur.</p>
                <p>Would you like to correct the Experiment Name in RunParameters.xml to match the SampleSheet?</p>
                <form method="post">
                    <input type="hidden" name="run_parameters_path" value="{{ results.run_parameters_path }}">
                    <input type="hidden" name="new_experiment_name" value="{{ results.experiment_name }}">
                    <button type="submit" name="correct_experiment_name" class="btn btn-warning">Correct RunParameters.xml</button>
                </form>
            </div>
        {% endif %}

        {% if not results.errors and not results.experiment_name_mismatch %}
            <div class="alert alert-success">
                SampleSheet is valid! File has been moved to the correct location, status will be updated in the run monitor shortly.
            </div>
        {% endif %}
    {% endif %}

    <!-- Page Title Card -->
    <div class="card shadow-sm mb-4">
        <div class="card-body text-center bg-light">
            <h4 class="my-1 page-title">SampleSheet Validator</h4>
        </div>
    </div>

    <form method="post" enctype="multipart/form-data">
        <div class="mb-3">
            <label for="file" class="form-label">Upload SampleSheet</label>
            <input type="file" class="form-control" id="file" name="file" accept=".csv">
        </div>
        <button type="submit" class="btn btn-primary">Validate</button>
    </form>
{% endblock %}
